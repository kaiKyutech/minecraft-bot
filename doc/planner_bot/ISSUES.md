# Planner Bot - 現在の課題

**最終更新**: 2025-10-19

このドキュメントは現在発生している問題、未解決の課題、既知のバグを記録します。
設計詳細は [ARCHITECTURE.md](./ARCHITECTURE.md)、実装状況は [IMPLEMENTATION_STATUS.md](./IMPLEMENTATION_STATUS.md) を参照してください。

---

## 目次

- [重要度: 高](#重要度-高)
- [重要度: 中](#重要度-中)
- [重要度: 低](#重要度-低)
- [解決済み](#解決済み)

---

## 重要度: 高

### Pathfinder タイムアウト問題

**問題**: `gather_*` スキル実行時に pathfinder が `moveTo timeout` で頻繁に失敗し、無駄なリプランニングが発生する。

**発生条件**:
- 近接した障害物（クラフト台、設置物など）がボットの足元や前面にある
- 掘削後のドロップ回収時に足元に障害物が残っている

**現在の影響**:
- リプランニング連続発生 → 探索上限に到達
- 効率的なリソース採集の妨げ

**既存の対策**:
- ✅ 掘削直後にインベントリ差分を確認し、アイテムが増えた場合はドロップ回収をスキップ
- ✅ pathfinder の足場を `dirt` のみに制限し、手持ちの cobblestone を消費しない

**検討中の対策案**:

1. **移動直前に周囲の邪魔なブロックを排除**
   - 1ブロック以内の障害物を掘削してから pathfinder 実行
   - 条件: 「初回の大きな移動が必要な時のみ」など距離判定で制限

2. **周囲の空きチェック & 強制再配置**
   - `moveTo` 前に周囲1ブロックの空き具合をチェック
   - 空きがない場合は短距離で別方向にずれる or 足元のブロックを掘る

3. **ブロック種類ごとの掘削可否**
   - 自然物 (`dirt`, `*_log`) は掘っても問題少ない
   - 設備ブロック (チェスト、ワークベンチ) の扱いは要検討

4. **距離判定での2段階 approach**
   - 長距離移動（4ブロック以上）の場合のみ周囲整理→`moveTo`
   - 短距離では従来通り（連続採掘時の余計な整理を避ける）

5. **掘削前段階での待機**
   - 移動直前に短い `delay` + 後退操作 (`setControlState('back', true)`) で位置をずらす

**実装時の検討事項**:
- 連続採掘時に毎回土台を削ると効率が悪化
- ブロック破壊はワールド保全やプレイヤーの意図と整合性が必要
- `primitives.moveTo` 呼び出し前の整地処理を共通化し、重複をなくす

**関連ファイル**:
- `planner_bot/src/skills/gather.js`
- `planner_bot/src/primitives.js` (moveTo)
- `doc/implementation/gather-movement-notes.md`

---

### 視覚システムの未テスト

**問題**: Observer Pool と Camera-Bot のコードは実装済みだが、実際の動作テストが未実施。

**未検証項目**:
- Camera-Bot の prismarine-viewer 起動
- TP 機能 (AI Bot の位置に移動)
- 視線方向設定 (yaw, pitch)
- Puppeteer ブラウザ起動
- スクリーンショット撮影
- Base64 画像データ取得
- オーバーレイ表示 (位置・方角情報)

**リスク**:
- 実際に動作しない可能性がある
- パフォーマンス問題が発生する可能性
- メモリリークやブラウザクラッシュの可能性

**対策**:
- ✅ `!creative vision capture` コマンド実装済み
- ❌ 実際にコマンドを実行してテスト必要
- ❌ エラーハンドリング、タイムアウト処理の検証

**関連ファイル**:
- `planner_bot/src/bot/camera_bot.js`
- `planner_bot/src/bot/observer_pool.js`
- `planner_bot/src/creative_actions/vision.js`

---

### 相対的な地形情報取得機能の未実装

**問題**: 自分の位置を基準にした周囲ブロックの相対的な高さを取得する機能がない。

**必要性**:
- 画像なしで大体の地形を把握するため
- カメラ撮影時の方向・角度決定に使用
- 移動経路の選定（登る/降りる判断）
- 建築時の地形確認

**実装案**:
```javascript
// 例: 自分の位置から半径10ブロック以内の高さマップを取得
bot.getRelativeHeightMap({ radius: 10, step: 1 })
// => {
//   "0,0": 0,    // 自分の位置
//   "1,0": -1,   // X+1方向が1ブロック低い
//   "0,1": 2,    // Z+1方向が2ブロック高い
//   ...
// }
```

**活用例**:
- 「北側が高台、南側が平地」などの地形判断
- カメラで撮影する方向の選定（高い方向を見る、など）
- 穴や崖の検出

**関連ファイル**:
- `planner_bot/src/primitives.js` (新規関数追加)
- `planner_bot/src/creative_actions/vision.js` (撮影方向決定に使用)

---

## 重要度: 中

### LLM 統合の未実装

**問題**: 会話履歴システムは実装済みだが、LLM への送信機能が未実装。

**現状**:
- ✅ 会話履歴の記録 (`bot.addMessage()`)
- ✅ フィルタリング機能 (`bot.getConversationHistory()`)
- ❌ LLM API への画像送信
- ❌ LLM からのコマンド受信
- ❌ 自然言語による目標設定
- ❌ LLM による状況判断

**必要な実装**:
1. LLM API クライアント (OpenAI, Claude, etc.)
2. 会話履歴 → LLM プロンプト変換
3. 画像データの LLM への送信 (vision モデル)
4. LLM レスポンス → コマンド解析
5. エラーハンドリング、リトライ処理

**関連ファイル**:
- `planner_bot/src/llm/` (未作成)
- `planner_bot/src/bot/ai_bot.js`

---

### 会話履歴の永続化

**問題**: 現在の会話履歴はメモリ上のみで、ボット再起動時に消失する。

**影響**:
- 長期的な会話コンテキストが失われる
- デバッグ時の履歴確認が困難

**対策案**:
1. JSON ファイルへの定期保存
2. SQLite データベースへの記録
3. タイムスタンプ付きログファイル

**実装時の検討事項**:
- 保存タイミング (1分ごと、メッセージごと、シャットダウン時)
- ファイルフォーマット (JSON, JSONL, SQLite)
- 保存先ディレクトリ (`logs/`, `data/`)
- 最大保存期間・サイズ制限

---

### 会話履歴への記録ポリシーが不明瞭

**問題**: 現在、何を会話履歴に記録するかの基準が一貫していない。

**現状**:
- ✅ プレイヤーの自然言語メッセージ (`!` で始まらない)
- ✅ GOAPエラー・診断情報 (`system_info`)
- ✅ コマンドのエラーメッセージ (`system_info`)
- ✅ `!echo` のテスト応答 (`bot_response`)
- ❌ コマンドの成功メッセージ (すべてコメントアウト)
- ❌ Creative Actions の結果 (コメントアウト)
- ❌ Skill/Primitive の完了メッセージ (コメントアウト)

**問題点**:
- エラーのみ記録され、成功時の情報が欠落
- 「何が履歴に入るか」がコードを読まないと分からない
- コマンドハンドラごとに実装が異なる

**将来のライブラリ化に向けた改善案**:
1. **デフォルトでは何も履歴に記録しない**
   - コマンドハンドラは戻り値のみを返す
   - 履歴への記録はユーザーが明示的に制御

2. **会話履歴記録の制御を外部化**
   - 設定ファイルで「どのイベントを記録するか」を定義
   - 例: `recordPolicy: { errors: true, success: false, userMessages: true }`

3. **イベントベースの記録**
   - コマンドハンドラはイベントを発火
   - ユーザーがリスナーで履歴記録を制御

**現状の回避策**:
- LLM統合時にコメントアウトを解除して調整
- 当面はエラー情報と自然言語のみ記録

**関連ファイル**:
- `planner_bot/src/commands/creative_command.js` (:78-79)
- `planner_bot/src/commands/skill_command.js` (:49-50)
- `planner_bot/src/commands/primitive_command.js` (:52)
- `planner_bot/src/commands/goal_command.js` (:71, :80)

---

### 周辺情報取得機能の強化

**問題**: 周辺のプレイヤー・Mob・ブロック情報を取得する機能が不十分。

**現状**:
- ✅ GOAP用の材料検索 (`bot.findBlock`) - 一部実装済み
- ❌ 周辺のプレイヤー一覧取得
- ❌ 周辺のMob一覧取得
- ❌ ブロック情報の詳細取得（種類、位置、距離）
- ❌ 構造化されたAPI

**必要性**:
- 周辺にプレイヤーがいれば話しかける
- カメラ機能で特定のプレイヤーの行動を観察
- Mobの種類・位置を把握（戦闘、回避）
- 建築物の認識

**実装案**:
```javascript
// 周辺のエンティティ情報
bot.getNearbyEntities({ radius: 20, type: 'player' })
// => [{ username: 'PlayerA', distance: 5.2, position: {...} }, ...]

bot.getNearbyEntities({ radius: 20, type: 'mob' })
// => [{ name: 'zombie', distance: 10.5, position: {...}, hostile: true }, ...]

// 周辺のブロック情報（種類別）
bot.getNearbyBlocks({ radius: 10, blockType: 'crafting_table' })
// => [{ position: {...}, distance: 3.2 }, ...]
```

**活用例**:
- 「PlayerAが近くにいるので話しかける」
- 「ゾンビが10ブロック先にいるので警戒」
- 「クラフト台が3ブロック先にあるので利用」

**関連ファイル**:
- `planner_bot/src/primitives.js` (新規関数追加)
- `planner_bot/src/planner/state_builder.js` (状態構築に使用)

---

### インベントリ管理機能の不足

**問題**: ボットは自動的にインベントリを整理しない。

**現状の不便さ**:
- 不要なアイテムが溜まる (cobblestone, dirt, etc.)
- チェストへの収納機能がない
- アイテム転送機能がない

**必要な機能**:
1. アイテム整理 (同種アイテムをスタック)
2. 不要アイテムの破棄
3. チェスト操作 (開く、アイテム入出庫)
4. アイテム転送 (ボット間、ボット↔チェスト)

**実装時の検討事項**:
- 「不要」の定義 (ユーザー設定? 自動判断?)
- チェスト操作の前提条件 (チェストの発見、接近)
- アイテム優先度の設定

---

## 重要度: 低

### 探索システムの未実装

**問題**: ランダム探索、特定ブロック探索など探索機能が未実装。

**必要な機能**:
- ❌ `randomWalk` - ランダム探索
- ❌ `searchBlock` - 特定ブロック探索
- ❌ `returnHome` - 帰還
- ❌ マッピング (訪問済みチャンク記録)
- ❌ 未探索エリア優先探索

**実装先**: `planner_bot/src/creative_actions/exploration.js`

---

### 建築システム・設計図機能の未実装

**問題**: 設計図に基づく建築機能が未実装。

**設計方針**:
- LLMの性能に極度に依存しない設計図システムを導入
- 建築だけでなく、他の用途にも使えるようにする
  - 他のプレイヤーやボットとの意思疎通ツール
  - 位置情報の共有
  - 作業手順の記録

**必要な機能**:
- ❌ 設計図フォーマット定義（汎用的な構造）
- ❌ 設計図読み込み・保存
- ❌ ブロック配置計画
- ❌ 建築実行
- ❌ 建築進捗管理
- ❌ 設計図の共有・送受信
- ❌ 建築バリデーション（プレイヤーが通れるか、実用的かの判定）

**設計図の活用例**:
1. **建築**: 「この場所にこの建物を建てる」
2. **意思疎通**: 「この設計図の通りに作業してほしい」とボット間で共有
3. **記録**: 「この手順で作業した」という履歴

**建築バリデーションの必要性**:
- LLMは基本的な建築を知識として持つが、実用性の判定は困難
- マイクラ世界特有のルール（プレイヤーが通れる高さ・幅、窒息判定など）を検証
- バリデーション結果をLLMにフィードバックし、設計図を修正

**実装先**:
- `planner_bot/src/creative_actions/building.js`
- `planner_bot/src/blueprints/` (設計図管理)

---

### 音情報取得機能の未実装

**問題**: 周辺で鳴っている音を検知する機能がない。

**必要性**:
- 敵対Mobの存在を音で検知（ゾンビの唸り声、クリーパーのシュー音など）
- プレイヤーの行動を音で推測（掘削音、足音など）
- 環境音の把握（雨、雷など）

**実装案**:
```javascript
bot.getNearbyAudio({ radius: 20 })
// => [
//   { sound: 'entity.zombie.ambient', distance: 12.3, direction: 'north' },
//   { sound: 'block.stone.break', distance: 5.1, direction: 'east' },
//   ...
// ]
```

**活用例**:
- 「ゾンビの音が聞こえるので警戒」
- 「誰かが近くで掘っているようだ」
- 「雨が降り始めた」

**技術的課題**:
- Mineflayer が音情報を提供しているか確認が必要
- 音の方向・距離の推定方法

**関連ファイル**:
- `planner_bot/src/primitives.js` (新規関数追加)

---

### 戦闘システムの未実装

**問題**: 敵対 Mob への対応機能が未実装。

**必要な機能**:
- ❌ 敵対 Mob 検出
- ❌ 攻撃アクション
- ❌ 回避・防御
- ❌ HP 管理

**実装先**: `planner_bot/src/skills/combat.js` (未作成)

---

### その他の未実装機能

**村人関連**:
- ❌ 村人取引
- ❌ 村人の探索

**高度なクラフト**:
- ❌ エンチャント
- ❌ 醸造
- ❌ レッドストーン回路

**農業**:
- ❌ 作物植え付け
- ❌ 自動農場
- ❌ 動物繁殖

---

## 解決済み

### ~~会話履歴の設計~~ (✅ 2025-10-19 解決)

**問題**: 会話履歴をユーザーごとに分けると、複数のボットと複数のプレイヤーが協調する際に不便。

**解決策**: 全員の発言を時系列で単一の配列に保存し、フィルタリング機能で特定ユーザーの発言を抽出できるように変更。

**変更内容**:
- `Map<username, messages[]>` → `Array` (単一配列)
- `bot.addMessage(username, speaker, content, type)` → `bot.addMessage(speaker, content, type)`
- `bot.getConversationHistory(options)` でフィルタリング機能追加

---

### ~~ログシステムの混乱~~ (✅ 2025-10-19 解決)

**問題**: `bot.detailLog()` と `bot.systemLog()` の使い分けが不明瞭。

**解決策**: 完全に分離した3つの関数を定義:
- `bot.systemLog()` - コンソール出力のみ
- `bot.speak()` - MC whisper のみ
- `bot.addMessage()` - 会話履歴のみ (自動でコンソール出力)

---

### ~~ドキュメント構成の混乱~~ (✅ 2025-10-19 解決)

**問題**: `doc/` ディレクトリの構成が不明瞭で、どこに何を書くべきか分からない。

**解決策**: ドキュメントの役割を明確に分離:
- `API.md` - 使い方 (ユーザー向け)
- `IMPLEMENTATION_STATUS.md` - 実装状況チェックリスト (開発者向け)
- `ARCHITECTURE.md` - 設計詳細・システムフロー (開発者向け)
- `ISSUES.md` - 現在の課題・未解決問題 (このファイル)

---

## 関連ドキュメント

- [API.md](./API.md) - 使い方・コマンドリファレンス
- [IMPLEMENTATION_STATUS.md](./IMPLEMENTATION_STATUS.md) - 実装状況チェックリスト
- [ARCHITECTURE.md](./ARCHITECTURE.md) - 設計詳細・システムフロー
- [gather-movement-notes.md](../implementation/gather-movement-notes.md) - Pathfinder 問題の詳細
