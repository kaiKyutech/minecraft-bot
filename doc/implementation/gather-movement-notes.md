# Gather Movement Notes

## 現状の課題
- `gather_*` スキル実行時には、対象ブロックに向けて pathfinder を呼び出している（`gather.js` 内で `primitives.moveTo`）。
- 近接した障害物（特にクラフト台などの設置物）がプレイヤーの足元や前面に残っていると、pathfinder が `moveTo timeout` で失敗しリプラン→探索上限に至るケースが多発。
- 掘削後のドロップ回収でも同様で、足元に障害物が残っていると拾いに行く過程でタイムアウトし、無駄な再計画を招く。

## 直近で導入した改善
- 掘削直後にインベントリ差分を確認し、目的アイテムが増えた場合はドロップ回収をスキップすることで余分な `moveTo` を抑制。
- pathfinder が足場に使うブロックを `dirt` のみに制限し、手持ちの cobblestone などを消費しないように調整。
- それでも足元の障害物で停滞するケースが残っている。

## 追加で検討したい対策案
1. **移動直前に周囲の邪魔なブロックを排除**
   - 拾ったクラフト台や木材など、明らかに移動の妨げになるブロックが 1 ブロック以内にある場合、それを掘削してから pathfinder を実行。
   - ただし連続して同じ場所で採掘する際に毎回周囲を削ってしまうと逆に非効率なため、「初回の大きな移動が必要な時のみ」など条件付きにする必要がある。

2. **周囲の空きチェック & 強制再配置**
   - `moveTo` を呼ぶ前に、自分の周囲 1 ブロックの空き具合をチェックし、空きがない場合は短距離で別方向にずれるか、足元のブロックを掘る。
   - これにより、クラフト台の側面に張り付いた状態で `goto` することを避ける。

3. **ブロック種類ごとの掘削可否**
   - 土 (`dirt`) や原木 (`*_log`) といった自然物は掘っても問題が少ないため、ピックアップ対象の再利用可能な材料なら削ってから移動;
   - 中間地点にチェストやワークベンチなどの設備ブロックがある場合の扱いは要検討（壊すべきか、避けるべきか）。

4. **距離判定での2段階 approach**
   - 長距離移動（例: 4 ブロック以上）の場合だけ周囲整理→`moveTo` を実行し、短距離では従来通り。
   - これにより連続採掘時に余計な整理を避ける。

5. **掘削前段階での待機**
   - 移動直前に短い `delay` を挟み、bot が一歩後退する操作（`setControlState('back', true)` など）を 0.3 秒行って位置をずらす案も考えられる。

## 実装時の検討事項
- Gather スキルで毎回土台を削ると、その場での連続採掘が難しくなるため、距離や回数に応じて条件を付ける。
- ブロック破壊はワールドの保全やプレイヤーの意図と整合する必要がある。
- 代替案として、移動前に“空きスペースがあるか”を判定し、塞がっている場合のみ周囲のブロックを削る（例: 足元 `bot.entity.position.offset(x,0,z)`、頭上 `offset(x,1,z)`）などが考えられる。
- 以上を実装する際は、`primitives.moveTo` 呼び出し前の整地処理を共通化し、重複をなくすこと。

