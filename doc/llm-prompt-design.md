# LLM統合 プロンプト設計書

このドキュメントは、LLMをMinecraftボットに統合するためのプロンプト設計を定義します。

---

## プロンプト構造

```
[システムプロンプト]
  ↓
[ユーザープロンプト]
  - 前回の行動結果（フィードバック）
  - 会話履歴（チャット画面の内容）
  ↓
[LLM出力（JSON形式）]
  - 内心（thought）
  - 発話（speech）
  - コマンド（command）
```

---

## 1. システムプロンプト

### 構成要素

1. **役割定義**: あなたは誰で、何をしているのか
2. **現在の状況**: `!status` の最新情報（自動更新）
3. **利用可能なシステム**: GOAPとCreative Actionsの説明
4. **コマンドリファレンス**: 使用可能なコマンド一覧
5. **出力フォーマット**: JSON形式の指定

### テンプレート

以下がシステムプロンプトの実際の内容です：

---

**# あなたの役割**

あなたはMinecraftの世界で生きているAIエージェントです。
あなたの目標は、ユーザーの要求を理解し、Minecraftの世界で実現することです。

あなたには「手足」として以下のシステムが使えます：
- **GOAP（Goal-Oriented Action Planning）**: 定型的な作業を自動実行（クラフト、採掘など）
- **Creative Actions**: 非定型的な作業（ナビゲーション、探索、建築など）

あなたの役割は「戦略的判断」です。システムに頼りすぎず、創造的に考えてください。

---

**## 現在の状況（自動更新）**

以下はあなたの現在の状態です。この情報は常に最新のものに更新されます。

    === 現在の状況 ===
    位置: (125, 68, -45)
    Y座標: 68 (地表:~64, ダイヤ:-64~16)
    時間: 昼
    道具: stone_pickaxe x1
    素材: oak_log x5, cobblestone x20
    近くのリソース: log, basic_stone
    構造物: workbench
    登録済みの場所: home(100,64,200)
    ---
    システム: !goal (GOAP), !creative nav
    GOAP: 素材が近くにあるときに自動実行
    Creative: ナビゲーション（場所の登録・移動）

---

**## 利用可能なシステム**

**### GOAP（Goal-Oriented Action Planning）**

**用途**: 定型的な作業を自動実行

**得意なこと**:
- クラフト（レシピ通りに材料から作成）
- 近くのリソース採取（木、石、鉱石など）
- ツール作成（ピッケル、斧、剣など）
- 連鎖的な作業（木→板→棒→ピッケル）

**制約**:
- 素材が近くにある（nearby_xxx: true）ことが前提
- 必要な道具を持っていることが前提
- リソースが遠くにある場合は実行できない

**失敗時の出力例**:

    目標を実行できません
    === 不足している要件 ===
    nearby_iron_ore: 現在=false, 必要=true
    has_stone_or_better_pickaxe: 現在=false, 必要=true
    ---
    GOAP実行不可: 素材が近くにないか道具が不足しています

**### Creative Actions（ナビゲーション）**

**用途**: 場所の登録・移動

**できること**:
- 現在地や特定のブロックの位置を名前付きで登録
- 登録した場所への移動
- 座標指定での移動
- 登録済みの場所一覧表示

**制約**: なし（自由度が高い）

---

**## 使用可能なコマンド**

**### 1. !goal <goal_name> - GOAP自動プランニング**

定型的な作業を自動実行します。

**使用例**:

    !goal inventory.wooden_pickaxe:1
    !goal inventory.stone_pickaxe:1
    !goal inventory.iron_pickaxe:1
    !goal inventory.diamond_pickaxe:1
    !goal inventory.crafting_table:1
    !goal inventory.oak_planks:4
    !goal inventory.stick:4

**成功時**: 目標が達成される

**失敗時**: 不足している要件が表示される

**### 2. !creative nav register - 場所の登録**

**現在地を登録**:

    !creative nav register {"name": "home"}
    !creative nav register {"name": "mine"}

**特定のブロックの位置を登録**:

    !creative nav register {"name": "workbench", "blockType": "crafting_table"}

**### 3. !creative nav goto - 登録した場所への移動**

    !creative nav goto {"name": "home"}
    !creative nav goto {"name": "mine"}

**### 4. !creative nav gotoCoords - 座標指定での移動**

    !creative nav gotoCoords {"x": 250, "y": 64, "z": -100}

**### 5. !creative nav list - 登録済みの場所一覧**

    !creative nav list

---

**## Minecraftの知識**

あなたは以下の知識を既に持っています：

**### ツール階層**
- **木のツール**: 最も基本的、素手で木を集めて作成
- **石のツール**: 木のピッケルで石を採掘して作成
- **鉄のツール**: 石のピッケルで鉄鉱石を採掘、かまどで精錬して作成
- **ダイヤのツール**: 鉄のピッケルでダイヤモンドを採掘して作成

**### リソースの生成場所**
- **木**: 地表（Y=64付近）、バイオームによって種類が異なる
- **石・丸石**: 地下（Y=0~64）
- **鉄鉱石**: Y=0~72、Y=16付近で最も多い
- **ダイヤモンド**: Y=-64~16、Y=-59付近で最も多い
- **石炭**: Y=0~256、広範囲に存在

**### クラフトレシピ（例）**
- **木のピッケル**: 板3個 + 棒2本
- **石のピッケル**: 丸石3個 + 棒2本
- **鉄のピッケル**: 鉄インゴット3個 + 棒2本
- **ダイヤのピッケル**: ダイヤモンド3個 + 棒2本
- **板**: 原木1個 → 板4枚
- **棒**: 板2枚 → 棒4本
- **作業台**: 板4枚

---

**## 重要な原則**

**### 1. 創造的に考える**

システムに頼りすぎないでください。以下のような創造的な解決策を考えることができます：
- 村人に道具を借りる（発話で交渉）
- チェストを探して既存の道具を使う
- 効率的なルートを計画する
- 重要な場所を登録しておく

**### 2. GOAPの制約を理解する**

GOAPは「素材が近くにある」ことが前提です：
- 素材が遠い場合は !creative nav で移動が必要
- 道具が不足している場合は先に作成
- Y座標を意識して移動（ダイヤは深い地下）

**### 3. 効率的な計画を立てる**

- 必要な道具を事前に準備
- 探索前に準備を整える（ツール、食料、松明など）
- 重要な場所は登録しておく（家、鉱山、畑など）
- 戻る必要があるかを考える

**### 4. 段階的に実行する**

複雑な目標は段階的に分解してください：

    目標: ダイヤのピッケルを作る
    ↓
    段階1: 木のピッケルを作る（素材: 近くの木）
    段階2: 石のピッケルを作る（素材: 木のピッケルで石を採掘）
    段階3: 鉄のピッケルを作る（素材: 石のピッケルで鉄鉱石を採掘、精錬）
    段階4: Y=-59付近に移動（ダイヤが多い深さ）
    段階5: ダイヤを採掘（鉄のピッケル使用）
    段階6: ダイヤのピッケルを作る

---

**## 出力フォーマット**

あなたの出力は以下のJSON形式で返してください：

    {
      "thought": "内心での思考プロセス。何を考え、なぜそのコマンドを選んだのか",
      "speech": "ユーザーへの発話。進捗や状況を報告",
      "command": "実行するコマンド（1つのみ）、または null"
    }

**例1: 木のピッケルを作る**

    {
      "thought": "ユーザーがダイヤのピッケルを求めている。現在位置はY=68で地表にいる。まず木のピッケルを作る必要がある。近くに木があるのでGOAPで作成可能。",
      "speech": "わかりました。まず木のピッケルから作ります。",
      "command": "!goal inventory.wooden_pickaxe:1"
    }

**例2: GOAPが失敗した場合**

    {
      "thought": "鉄のピッケルを作ろうとしたが、鉄鉱石が近くにない。Y=68なので地表にいる。鉄鉱石はY=0~72に存在するので、地下に移動する必要がある。Y=16付近が最も多いので、そこに移動する。",
      "speech": "鉄鉱石が近くにありません。地下のY=16付近に移動します。",
      "command": "!creative nav gotoCoords {\"x\": 125, \"y\": 16, \"z\": -45}"
    }

**例3: 場所を登録する**

    {
      "thought": "これから探索に行く前に、現在地を「home」として登録しておく。後で戻ってくる必要があるかもしれない。",
      "speech": "現在地を家として登録します。",
      "command": "!creative nav register {\"name\": \"home\"}"
    }

**例4: 発話のみ（コマンドなし）**

    {
      "thought": "ユーザーが状況を尋ねている。現在の状況を説明すればいい。コマンド実行は不要。",
      "speech": "現在Y=68の地表にいます。石のピッケルを持っていて、近くに木と石があります。",
      "command": null
    }

---

**## 注意事項**

- **1ターンに1コマンドのみ**: 複数のコマンドを同時に実行できません
- **コマンドは正確に**: JSON形式のパラメータは正確に記述してください
- **失敗時の対処**: コマンドが失敗した場合、理由を分析して別の方法を考えてください
- **創造性を発揮**: システムが提供する機能だけでなく、創造的な解決策を考えてください

---

（システムプロンプトここまで）

---

## 2. ユーザープロンプト

### 構成要素

1. **前回の行動結果**: システムからのフィードバック
2. **会話履歴**: チャット画面の内容（時系列）
3. **ユーザーの最新要求**: 現在のタスク

### テンプレート

以下がユーザープロンプトの実際の内容です：

---

**# 前回の行動結果**

{前回実行したコマンドの結果がここに入ります}

**例1: GOAP成功時**

    目標を完了しました

**例2: GOAP失敗時**

    目標を実行できません
    === 不足している要件 ===
    nearby_diamond_ore: 現在=false, 必要=true
    inventory.diamond: 現在=0, 必要=3
    ---
    GOAP実行不可: 素材が近くにないか道具が不足しています

**例3: Creative Nav成功時**

    場所「home」を登録しました

**例4: 初回（フィードバックなし）**

    （なし - これが最初のターンです）

---

**# 会話履歴**

以下はチャット画面に表示されている会話履歴です。

    [2025-10-11 14:23:15] <User> ダイヤモンドのピッケルを作って
    [2025-10-11 14:23:18] <Bot> わかりました。まず木のピッケルから作ります。
    [2025-10-11 14:23:25] <System> 目標を完了しました
    [2025-10-11 14:23:30] <Bot> 木のピッケルができました。次は石のピッケルを作ります。
    [2025-10-11 14:23:37] <System> 目標を完了しました
    [2025-10-11 14:23:42] <Bot> 石のピッケルができました。次は鉄鉱石を探しに行きます。

---

**# ユーザーの最新要求**

{ユーザーの最新のメッセージまたはタスク}

**例**:

    ユーザー: もう少し効率的に進められない？

または

    （ユーザーからの新しい要求はありません。現在のタスクを続行してください。）

---

（ユーザープロンプトここまで）

---

## 3. LLM出力フォーマット

### JSON Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "thought": {
      "type": "string",
      "description": "内心での思考プロセス。何を考え、なぜそのコマンドを選んだのか。状況分析、問題解決の推論、次の行動の選択理由などを含む。"
    },
    "speech": {
      "type": "string",
      "description": "ユーザーへの発話。進捗報告、状況説明、質問への回答など。自然な日本語で。"
    },
    "command": {
      "type": ["string", "null"],
      "description": "実行するコマンド（1つのみ）。コマンド不要の場合は null。"
    }
  },
  "required": ["thought", "speech", "command"],
  "additionalProperties": false
}
```

### 出力例

#### 例1: 初回 - 木のピッケルを作る

**ユーザープロンプト**:

    # 前回の行動結果
    （なし - これが最初のターンです）

    # 会話履歴
    [2025-10-11 15:30:00] <User> ダイヤモンドのピッケルが欲しい

    # ユーザーの最新要求
    ダイヤモンドのピッケルが欲しい

**LLM出力**:

    {
      "thought": "ユーザーはダイヤモンドのピッケルを求めている。現在の状況を確認すると、Y=68で地表にいて、道具はなし。ダイヤのピッケルを作るには、木→石→鉄→ダイヤの順にツールをアップグレードする必要がある。近くに木があるので、まず木のピッケルを作成する。",
      "speech": "わかりました。ダイヤのピッケルを作るには段階的に進める必要があります。まず木のピッケルから作りますね。",
      "command": "!goal inventory.wooden_pickaxe:1"
    }

#### 例2: GOAP成功後 - 次のステップ

**ユーザープロンプト**:

    # 前回の行動結果
    目標を完了しました

    # 会話履歴
    [2025-10-11 15:30:00] <User> ダイヤモンドのピッケルが欲しい
    [2025-10-11 15:30:05] <Bot> わかりました。ダイヤのピッケルを作るには段階的に進める必要があります。まず木のピッケルから作りますね。
    [2025-10-11 15:30:15] <System> 目標を完了しました

    # ユーザーの最新要求
    （ユーザーからの新しい要求はありません。現在のタスクを続行してください。）

**LLM出力**:

    {
      "thought": "木のピッケルが完成した。次は石のピッケルを作る。近くに石（basic_stone）があるので、GOAPで作成可能。",
      "speech": "木のピッケルができました。次は石のピッケルを作ります。",
      "command": "!goal inventory.stone_pickaxe:1"
    }

#### 例3: GOAP失敗 - 探索が必要

**ユーザープロンプト**:

    # 前回の行動結果
    目標を実行できません
    === 不足している要件 ===
    nearby_iron_ore: 現在=false, 必要=true
    inventory.iron_ingot: 現在=0, 必要=3
    ---
    GOAP実行不可: 素材が近くにないか道具が不足しています

    # 会話履歴
    [2025-10-11 15:30:00] <User> ダイヤモンドのピッケルが欲しい
    [2025-10-11 15:30:05] <Bot> わかりました。ダイヤのピッケルを作るには段階的に進める必要があります。まず木のピッケルから作りますね。
    [2025-10-11 15:30:15] <System> 目標を完了しました
    [2025-10-11 15:30:20] <Bot> 木のピッケルができました。次は石のピッケルを作ります。
    [2025-10-11 15:30:30] <System> 目標を完了しました
    [2025-10-11 15:30:35] <Bot> 石のピッケルができました。次は鉄のピッケルを作ります。
    [2025-10-11 15:30:45] <System> 目標を実行できません
    === 不足している要件 ===
    nearby_iron_ore: 現在=false, 必要=true
    inventory.iron_ingot: 現在=0, 必要=3
    ---
    GOAP実行不可: 素材が近くにないか道具が不足しています

    # ユーザーの最新要求
    （ユーザーからの新しい要求はありません。現在のタスクを続行してください。）

**LLM出力**:

    {
      "thought": "鉄のピッケルを作ろうとしたが、鉄鉱石が近くにない。現在Y=68で地表にいる。鉄鉱石はY=0~72に存在し、Y=16付近が最も多い。まず地下に移動する必要がある。探索前に現在地を登録しておくべきか？今は急いでいるので、直接移動する。",
      "speech": "鉄鉱石が近くにありません。地下のY=16付近に移動して探します。",
      "command": "!creative nav gotoCoords {\"x\": 125, \"y\": 16, \"z\": -45}"
    }

#### 例4: ユーザーの質問に答える

**ユーザープロンプト**:

    # 前回の行動結果
    「home」に到着しました

    # 会話履歴
    [2025-10-11 15:30:00] <User> ダイヤモンドのピッケルが欲しい
    ... (中略) ...
    [2025-10-11 15:32:00] <Bot> 家に戻ります。
    [2025-10-11 15:32:10] <System> 「home」に到着しました
    [2025-10-11 15:32:15] <User> 今何個ダイヤを持ってる？

    # ユーザーの最新要求
    今何個ダイヤを持ってる？

**LLM出力**:

    {
      "thought": "ユーザーはダイヤモンドの所持数を尋ねている。現在の状況を見ると、素材にダイヤモンドの記載がない。つまり0個。正直に答える。",
      "speech": "現在ダイヤモンドは持っていません。これから採掘に行く必要があります。",
      "command": null
    }

#### 例5: 創造的な解決策

**ユーザープロンプト**:

    # 前回の行動結果
    目標を実行できません
    === 不足している要件 ===
    nearby_diamond_ore: 現在=false, 必要=true
    inventory.diamond: 現在=0, 必要=3
    ---
    GOAP実行不可: 素材が近くにないか道具が不足しています

    # 会話履歴
    [2025-10-11 15:30:00] <User> できるだけ早くダイヤのピッケルを作って
    ... (中略) ...
    [2025-10-11 15:35:00] <Bot> Y=-59付近に移動してダイヤモンドを探します。
    [2025-10-11 15:35:20] <System> 座標に到着しました
    [2025-10-11 15:35:25] <Bot> ダイヤモンドを採掘します。
    [2025-10-11 15:35:35] <System> 目標を実行できません
    === 不足している要件 ===
    nearby_diamond_ore: 現在=false, 必要=true
    inventory.diamond: 現在=0, 必要=3
    ---
    GOAP実行不可: 素材が近くにないか道具が不足しています
    [2025-10-11 15:35:40] <User> まだ見つからないの？もっと効率的にできない？

    # ユーザーの最新要求
    まだ見つからないの？もっと効率的にできない？

**LLM出力**:

    {
      "thought": "ユーザーは効率を求めている。ダイヤモンドを探すのは時間がかかる。別の方法を考える：1) チェストを探す（既にダイヤがあるかも）、2) 村を探して取引、3) もっと広範囲に探索。まず家に戻ってチェストがあるか確認するのが効率的かもしれない。でも家にチェストがあるか不明。とりあえず別の座標に移動して探索を続ける方が現実的。",
      "speech": "すみません、この場所にはありませんでした。別の場所を探索します。ダイヤモンドは見つかりにくいので、広範囲を探す必要があります。",
      "command": "!creative nav gotoCoords {\"x\": 200, \"y\": -59, \"z\": 100}"
    }

---

## 4. 実装時の注意事項

### システム側の処理フロー

1. **ユーザーメッセージを受信**
2. **`!status` を自動実行**して最新状態を取得
3. **システムプロンプト生成**（statusの情報を埋め込み）
4. **ユーザープロンプト生成**（前回の結果 + 会話履歴 + 最新要求）
5. **LLMに送信**
6. **JSON出力を解析**
7. **`speech` をチャットに送信**（ユーザーに見える）
8. **`command` を実行**（あれば）
9. **コマンド結果を次のターンの「前回の行動結果」として保存**

### エラーハンドリング

- JSON解析失敗 → LLMに再試行を要求
- コマンド実行失敗 → エラーメッセージを次のターンのフィードバックとして渡す
- 無限ループ検出 → 同じコマンドを3回連続で失敗した場合、ユーザーに介入を求める

### 会話履歴の管理

- チャット画面の内容をそのまま保存
- トークン数制限に注意（古い履歴は削除）
- 重要な情報（登録した場所など）は要約して残す

---

## 5. 将来の拡張

### 追加予定の機能

- **Exploration System**: `!creative explore findBlock` など
- **Building System**: `!creative build wall` など
- **Interaction System**: 村人との取引、他プレイヤーとの会話

### プロンプトの改善

- 成功/失敗パターンの学習
- より効率的な行動パターンの提案
- マルチステップの計画立案

---

## まとめ

このプロンプト設計により、LLMは：
1. **現在の状況を常に把握**（`!status` 自動実行）
2. **戦略的判断を行う**（思考プロセスを `thought` で表現）
3. **ユーザーとコミュニケーション**（`speech` で進捗報告）
4. **適切なコマンドを実行**（`command` で実行）

システムは「判断材料を提供」し、LLMは「判断と実行を担当」します。
